version: '3.9'

networks:
  ecom-net:
    driver: bridge

volumes:
  keycloak-db-data:


services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks: [ ecom-net ]

  kafka:
    image: confluentinc/cp-kafka:7.3.0
    depends_on: [ zookeeper ]
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CREATE_TOPICS: "orders-topic:1:1"
    networks: [ ecom-net ]

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    networks: [ ecom-net ]

  keycloak:
    image: quay.io/keycloak/keycloak:25.0.6
    command: [ "start-dev", "--import-realm" ]
    depends_on: [ postgres ]
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports:
      - "8080:8080"
    networks: [ ecom-net ]

  config-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: config-service
    environment:
      CONFIG_PROFILE: native
      CONFIG_NATIVE_LOCATION: file:/config-repo
    volumes:
      - ./ecom-app-config-repo:/config-repo:ro
    ports:
      - "9999:9999"
    networks: [ ecom-net ]

  discovery-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: discovery-service
    depends_on: [ config-service ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
    ports:
      - "8761:8761"
    networks: [ ecom-net ]

  gateway-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: gateway-service
    depends_on: [ config-service, discovery-service ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
      DISCOVERY_HOST: discovery-service
      DISCOVERY_PORT: 8761
      KEYCLOAK_HOST: keycloak
      KEYCLOAK_PORT: 8080
    ports:
      - "8888:8888"
    networks: [ ecom-net ]

  customer-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: customer-service
    depends_on: [ config-service, discovery-service ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
      DISCOVERY_HOST: discovery-service
      DISCOVERY_PORT: 8761
      KEYCLOAK_HOST: keycloak
      KEYCLOAK_PORT: 8080
    networks: [ ecom-net ]

  inventory-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: inventory-service
    depends_on: [ config-service, discovery-service, kafka ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
      DISCOVERY_HOST: discovery-service
      DISCOVERY_PORT: 8761
      KEYCLOAK_HOST: keycloak
      KEYCLOAK_PORT: 8080
      KAFKA_HOST: kafka
      KAFKA_PORT: 9092
    networks: [ ecom-net ]

  billing-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: billing-service
    depends_on: [ config-service, discovery-service, kafka ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
      DISCOVERY_HOST: discovery-service
      DISCOVERY_PORT: 8761
      KEYCLOAK_HOST: keycloak
      KEYCLOAK_PORT: 8080
      KAFKA_HOST: kafka
      KAFKA_PORT: 9092
    networks: [ ecom-net ]

  supplier-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: supplier-service
    depends_on: [ config-service, discovery-service, kafka ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
      DISCOVERY_HOST: discovery-service
      DISCOVERY_PORT: 8761
      KEYCLOAK_HOST: keycloak
      KEYCLOAK_PORT: 8080
      KAFKA_HOST: kafka
      KAFKA_PORT: 9092
    networks: [ ecom-net ]

  analytics-service:
    build:
      context: ./ecom-app-backend-benatik
      dockerfile: Dockerfile
      args:
        SERVICE: analytics-service
    depends_on: [ config-service, discovery-service, kafka ]
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:9999
      DISCOVERY_HOST: discovery-service
      DISCOVERY_PORT: 8761
      KEYCLOAK_HOST: keycloak
      KEYCLOAK_PORT: 8080
      KAFKA_HOST: kafka
      KAFKA_PORT: 9092
    networks: [ ecom-net ]

  frontend:
    build:
      context: ./ecom-app-frontend-benatik
    depends_on: [ gateway-service ]
    ports:
      - "4200:80"
    networks: [ ecom-net ]

  chatbot:
    build:
      context: ./ecom-app-chatbot-benatik
    depends_on: [ gateway-service ]
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      TELEGRAM_TOKEN: ${TELEGRAM_TOKEN}
    networks: [ ecom-net ]
